# Chat UI (Web) — план редизайна по частям (UI Kit → наша реализация)

Цель: сделать **современный, аккуратный, Telegram/Slack‑like** интерфейс по мотивам Chat Web UI Kit (Figma). Двигаемся **по блокам**: Left → Header → Center messages → Composer → Reactions → Right InfoPanel → MediaViewer.

## Общие принципы (важно перед стартом)

1) **Меньше “контейнеров в контейнерах”**
- UI kit держится на чистых surface‑слоях, а не на множестве внутренних рамок.
- Вложения/карточки должны выглядеть как **один блок** внутри bubble, а не “карточка в карточке”.

2) **Единая типографика и плотность**
- Title (chat name) — акцент.
- Preview/secondary (snippet, статус, time) — меньше контраста.
- У всех списков одинаковая высота строки, одинаковые padding’и.

3) **Surface слои**
- Левый список — отдельная поверхность.
- Центр чата — отдельная поверхность.
- Правый InfoPanel — отдельная поверхность.
- Фоновая картинка/blur не должна “съедать” читаемость.

4) **Состояния**
- Hover/Active/Selected/Focus должны быть последовательными.
- Selected в списке чатов — **мягкая заливка + тонкий акцент**, без толстой рамки.

5) **Анимации**
- Минимальные: panel slide‑down / fade overlay / hover transitions.
- Без тяжёлых “прыгающих” layout‑shift.

---

# Этап 0 — Базовые токены UI (1 раз)

## 0.1 CSS tokens / theme variables
**Сделать:**
- Вынести (или подтвердить) базовые переменные:
  - `--surface-0` (page background)
  - `--surface-1` (sidebar)
  - `--surface-2` (chat area)
  - `--surface-3` (panel)
  - `--text-1`, `--text-2`, `--text-3`
  - `--border-1`, `--border-2`
  - `--shadow-1`
  - `--radius-sm/md/lg` (например 10/14/18)
  - `--gap-xs/sm/md/lg`

**Критерий готовности:**
- У всех блоков (лево/центр/право) одинаковый язык: border, radius, shadow, blur.

---

# Этап A — Левая часть (Channel / Chat list)

## A1. Layout и поверхность
**Цель UI kit:** слева — колонка фиксированной ширины, внутри search + list.

**Сделать:**
- Ширина: 320–360px (адаптивно: min 280 max 380).
- Header блока: “Чаты” + кнопка “new chat” (иконка).
- Search input: pill‑shape, иконка слева, placeholder серым.
- Разделитель между search и list: тонкая линия (border‑2) или внутренний padding.

**Не делать:** толстые рамки; сильные тени.

## A2. Элемент списка чатов (room row)
**Структура (как в kit):**
- Avatar слева
- Title + snippet по центру
- Time справа
- Unread badge (если есть)

**Сделать:**
- Высота строки 64–72px.
- Avatar 40–44px круглый.
- Title: 14–15px semi-bold.
- Snippet: 12–13px, `--text-2`, обрезка ellipsis.
- Time: 11–12px, `--text-3`.
- Selected state:
  - мягкая заливка `rgba(...)`
  - тонкий accent border слева или лёгкий glow.
  - **не** толстая рамка вокруг.
- Hover state: лёгкая заливка.

## A3. Live avatar sync
**Требование:** после смены аватара в профиле или у собеседника — список обновляется.

**Сделать:**
- Использовать signed avatars (уже сделано), но проверить:
  - invalidation после updateMe
  - refetch user list если нужен

**Критерий готовности:**
- Меняешь аватар → в списке чатов обновилось без F5.

## A4. Empty states & dropdowns (from UI kit)
- Пустое состояние списка каналов отображается с понятным текстом и иллюстрацией, согласно UI kit.
- Dropdown меню для Direct Messages (DM) содержит пункты: новый DM, создание группы и настройки.
- В списке упоминаний отображается отдельный entry с подсветкой и иконками, соответствующий UI kit скриншотам.

---

# Этап B — Верхний Header (центр)

## B1. Компоновка
**Цель UI kit:**
- Слева: back (на мобиле)
- Центр: avatar + name + subtitle (online/participants)
- Справа: search + menu (…)

**Сделать:**
- Высота header 64–72px.
- Центр кликабельный (open InfoPanel slide‑down / side panel).
- Subtitle:
  - direct: online/lastSeen
  - group: “N участников” + archived badge (если нужно)

## B2. Actions справа
**Сделать:**
- Search icon (пока без реализации глобального поиска — просто кнопка).
- Menu (…): открывает menu (mute/clear/leave etc.) позже.

**Критерий:** визуально ровные икон‑кнопки, одинаковые размеры, hover.

---

# Этап C — Центр (Message list)

## C1. Surface и фон
**Проблема сейчас:** blur/фон слишком активный.

**Сделать:**
- Ввести “chat surface layer” — подложку для списка сообщений (слегка затемнённую/осветлённую).
- Фон (wallpaper) оставляем, но снижаем влияние:
  - меньше blur
  - больше контраста bubble

## C2. Базовые bubble правила
**Цель UI kit:**
- Bubble простая, читаемая.
- Радиус одинаковый.
- Отступы внутри consistent.

**Сделать:**
- max width bubble: 60–68% (на wide desktop), на узких — 80–90%.
- Внутри bubble: padding 10–12px.
- Timestamp + ticks (для mine) — маленькие, менее контрастные.

## C3. Вложения (attachments) — единый блок
**Проблема сейчас:** карточка в карточке.

**Сделать:**
- Attachment block внутри bubble должен выглядеть как **единая карточка**:
  - image/video: превью dominates, минимум рамок
  - doc/pdf/zip: компактная строка с иконкой + имя + размер + кнопка download
- Убрать лишние внутренние border там где возможно.

## C4. Message stack (опционально)
UI kit показывает объединение подряд идущих сообщений одного автора.

**MVP:**
- не реализуем сложный stack сейчас
- но привести bubble radius к норме (не огромные скругления).

## C5. Message types & stacks (UI kit parity)
- Отдельное одиночное сообщение.
- Стек сообщений от одного автора (без лишних отступов между ними).
- Сообщения с текстом, изображением и подписью.
- Сообщения с текстом и превью ссылки.
- Фолбэк превью для ссылок без метаданных.
- Системные сообщения (например, уведомления о присоединении).
- Выделенное или связанное сообщение (highlighted/linked state).
- Сетка из нескольких изображений с оверлеем “+N” при превышении количества.

---

# Этап D — Reactions / Emoji (только под сообщениями)

## D1. Где показывать
**Требование:** реакции отображаются **под bubble**, а не поверх.

**Сделать:**
- Reaction row под сообщением:
  - маленькие pill’ы (emoji + count)
  - кликабельные
  - выравнивание по bubble (left/right)

## D2. Picker (позже)
**MVP:**
- пока без picker (или минимальный overlay)

## D3. Hover actions (reaction + menu)
- При наведении мыши на bubble отображается иконка смайлика (для добавления реакции) и меню с тремя точками (для дополнительных действий).
- Клик по смайлику открывает оверлей выбора реакции.
- Оверлей реакций выравнивается относительно bubble и не перекрывает текст.
- Меню с тремя точками появляется справа и содержит опции, соответствующие UI kit.

---

# Этап E — Composer (нижняя часть)

## E1. Layout
**Цель UI kit:**
- слева attach (+)
- input pill
- справа send

**Сделать:**
- Высота composer компактнее.
- Input в виде pill, placeholder.
- Send: круглая кнопка.

## E2. Previews при прикреплении
**Требование уже есть:** квадраты в ряд + “+N”.

**Полировка:**
- превью не должно увеличивать composer слишком сильно
- row горизонтальный скролл
- крестик удаления маленький

---

# Этап F — Правая часть (InfoPanel)

## F1. Поведение
**Цель UI kit:**
- panel открывается по клику на header title
- закрытие по X / overlay / ESC

**Сделать:**
- panel как отдельная поверхность справа (fixed width 340–420px)
- tabs pill‑style

## F2. Tabs и контент
### Group
- Участники (поиск)
- Медиа
- Ссылки
- Документы

### Direct
- Профиль (avatar, username, phone, birthday)
- Медиа
- Файлы
- Ссылки

**Важно:**
- единые list‑items
- одинаковые отступы

## F3. Mentions view
- Страница упоминаний отображается с заголовком и кнопкой назад к списку каналов.
- При клике на упоминание происходит скролл к соответствующему сообщению с визуальным выделением.
- Выделение сообщения сохраняется на время просмотра и плавно исчезает после.
- Визуальное выделение соответствует стилям UI kit (цвет, тень).

---

# Этап G — Media Viewer (overlay)

## G1. Требования
- Открытие по клику на media tile
- Закрытие: overlay click / X / ESC
- Навигация: стрелки или ArrowLeft/ArrowRight
- Кнопка Download

## G2. Fit / Scaling (твоя проблема: видео растягивается)
**Сделать обязательно:**
- Общий контейнер:
  - `max-width: 90vw`
  - `max-height: 82vh`
- Для изображения:
  - `object-fit: contain`
- Для видео:
  - `object-fit: contain`
  - `width: 100%`, `height: 100%`
  - запрет растягивания

**Критерий:**
- Фото и видео одинаково “вписаны” в окно без кропа.

## G3. Media viewer controls & scaling edge cases
- Автоматическое масштабирование изображений и видео с сохранением aspect ratio.
- Для изображений и видео применяется `object-fit: contain` для предотвращения обрезки.
- Видео не растягивается по ширине или высоте, занимает максимально возможное пространство внутри контейнера.
- Кнопка загрузки расположена в верхнем правом углу overlay, не перекрывая контент.
- Навигационные стрелки и кнопки управления видны и доступны на всех разрешениях.

---

# Этап H — Полная визуальная спецификация по мотивам UI kit (чтобы Codex не “не понял”)

Ниже — конкретные элементы, которые должны быть в итоге:

## H1. Channel list / left
- Заголовок “Чаты” слева, справа icon button (new chat)
- Search bar под заголовком
- List items:
  - avatar
  - name
  - preview
  - time
  - unread badge
- Selected: мягкая подсветка
- Hover: лёгкая подсветка

## H2. Center chat
- Top header:
  - avatar + title + subtitle
  - actions: search + menu
- Message list:
  - bubbles left/right
  - вложения аккуратно
  - реакции под bubble
- Composer:
  - attach
  - input
  - send
  - preview row вложений

## H3. Right panel
- Header: avatar + title + (edit button только если доступно) + close
- Tabs: pills (Participants/Media/Links/Docs)
- Content lists:
  - participants cards
  - media grid
  - links list
  - docs list

## H4. Overlay viewers
- Opened image/video overlay:
  - header with file name
  - close + download
  - content centered and contain

---

# TODO-порядок (как будем идти с Codex)

0) Tokens & базовые surface слои (Этап 0)
1) Left sidebar polish (A1–A2)
2) Header polish (B1–B2)
3) Center surface + bubbles cleanup (C1–C3)
4) Composer compact + preview row polish (E1–E2)
5) InfoPanel visual polish (F1–F2)
6) MediaViewer fit fix (G2) + polish
7) Reactions under message (D1)
8) Финальные состояния hover/active/focus + мелкие отступы

---

# Acceptance checklist (быстрый)

- [ ] Selected chat item выглядит как в kit (заливка, не толстая рамка)
- [ ] Chat surface читаемый, wallpaper не мешает
- [ ] Bubble/attachments не выглядят “карточка в карточке”
- [ ] Composer не высокий, превью компактные
- [ ] InfoPanel выглядит как продуктовая панель, tabs pill
- [ ] MediaViewer: и фото, и видео contain/fit без растяжения
- [ ] Реакции только под bubble
- [ ] После смены аватара обновляется в списке чатов

---

# Этап I — UI kit parity checklist (from screenshots)
- Dropdown меню DM содержит пункты: New DM, New Group, Dark mode toggle, Sign out.
- Правила fallback аватаров: инициаллы для пользователей без фото, сегментированные аватары для групп.
- Форматирование timestamp: отображение для сегодня, вчера, неделю назад, и дата для старых сообщений.
- Иконки delivery receipts (прочитано, доставлено) соответствуют UI kit.
- Индикатор набора текста отображается в списке каналов.
- Badge упоминаний стилизован согласно UI kit.
- Layout и стили выбора реакции (reaction picker) соответствуют UI kit.
# Этап J — Контекстные меню, диалоги и edit‑flows (полное соответствие UI Kit)

## 1. Контекстное меню сообщения (Right click / hover menu)
- Контекстное меню появляется при наведении курсора (hover) на bubble сообщения или по long‑press (на мобильных).
- Строгий порядок пунктов:
  1. Reply
  2. Thread Reply
  3. Edit Message (отображается только для своих сообщений)
  4. Pin to Conversation
  5. Delete Message (destructive, красный)
- Визуальные требования:
  - Используется surface‑слой (`surface‑3`) из UI kit.
  - Скругление радиуса: 12–14px.
  - Мягкая тень (shadow), как в UI kit, без резких контуров.
  - При наведении на пункт меню — строка подсвечивается (hover).
- Поведение:
  - Автоматическое позиционирование меню: если не помещается в окне — flip (отображается с другой стороны bubble).
  - Закрытие меню по ESC или клику вне меню.
  - Одновременно может быть открыто только одно контекстное меню (любое новое открытие закрывает предыдущее).

## 2. Delete confirmation dialog
- При попытке удалить сообщение открывается модальное окно подтверждения.
- Весь интерфейс приложения размывается и затемняется (blur + overlay).
- Диалог центрируется по экрану.
- Структура:
  - Заголовок: "Delete Message"
  - Текст подтверждения (уточняющий вопрос/предупреждение).
  - Кнопки:
    - Cancel (secondary)
    - Delete (destructive, primary red)
- Фокус‑trap: нельзя взаимодействовать с другими элементами вне диалога.
- ESC или клик вне диалога = действие Cancel (отмена удаления).

## 3. Pin message flow
- Pin и Unpin реализованы как toggle-действие (повторное нажатие снимает закрепление).
- После pin:
  - Сообщение появляется в InfoPanel (раздел закреплённых сообщений).
  - (Опционально) Краткий hint/тултип в header о закреплении.
- После unpin:
  - Сообщение исчезает из InfoPanel в реальном времени.
- Все изменения происходят без перезагрузки страницы, state обновляется мгновенно.

## 4. Edit message flow (image + caption)
- Редактирование запускается inline: bubble заменяется на editor‑surface прямо в списке сообщений.
- В editor:
  - Превью всех вложений отображаются в ряд.
  - У каждого вложения — крестик для удаления.
  - Input для caption/текста сообщения.
  - Кнопки Cancel и Send.
- Поведение:
  - Enter — отправляет отредактированное сообщение (Send).
  - Shift+Enter — добавляет новую строку.
  - Cancel возвращает исходное сообщение без изменений.
- Фон за editor слегка затемняется для выделения режима редактирования.

## 5. Общие interaction‑правила
- В любой момент времени может быть открыт только один активный overlay (контекстное меню, диалог удаления, редактор сообщения).
- Приоритет и Z‑index overlay:
  1. MediaViewer (самый верхний слой)
  2. Dialog (модальные окна)
  3. Context menu (контекстные меню)
  4. InfoPanel (панель справа)
- Overlay не должен ломать layout (разметку) или создавать проблемы со скроллом.

## 6. Acceptance checklist (UI Kit parity)
- Контекстное меню визуально полностью совпадает с UI kit (цвета, радиус, тень, порядок пунктов).
- Delete всегда выделен как destructive (красный цвет).
- Edit не ломает message list, не вызывает скачков layout.
- ESC работает для закрытия всех overlay (меню, диалоги, редактор).
- Поведение overlay и flows совпадает 1:1 со скринами и интерактивом UI kit.

---

Важно:
- Разрешено менять **логику UI и interaction**, если это нужно для точного соответствия UI Kit.
- Backend менять нельзя, но frontend‑логику (state, порядок рендера, overlays) — можно и нужно.
- Цель — **максимально точное визуальное и поведенческое соответствие**, а не сохранение старой реализации.