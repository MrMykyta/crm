# Спецификация модуля «Сделки»

## Обзор
Модуль «Сделки» предоставляет страницы списка и детального просмотра по маршрутам  
`/main/deals` и `/main/deals/:id`.

Доступ к данным осуществляется **исключительно через RTK Query**.  
Прямые HTTP‑вызовы в pages/components **запрещены**.

---

## Сценарии использования
- Просмотр списка сделок с пагинацией и фильтрами.
- Открытие сделки и просмотр основных данных (обзор).
- Изменение статуса сделки (Won / Lost) и редактирование ключевых полей.
- Архивация (удаление) сделки.
- Создание новой сделки со страницы списка.

---

## Права доступа
Backend‑маршруты проверяют следующие разрешения:
- `deal:read` — просмотр списка и карточки сделки
- `deal:create` — создание сделки
- `deal:update` — обновление данных и смена статуса (won/lost)
- `deal:delete` — архивирование или удаление

UI не обходит backend‑авторизацию.  
При отсутствии прав backend возвращает **403 Forbidden**.

---

## Store‑эндпоинты (RTK Query)
Реализованы в `client/src/store/rtk/dealsApi.js`:

### Получение списка
- `getDeals(args)` → `GET /deals`

Параметры:
`{ page, limit, q, sort, dir, filters }`

Поддерживаемые query‑параметры:
- `q`
- `status`
- `responsibleId`
- `counterpartyId`
- `pipelineId`
- `stageId`
- `dateFrom`
- `dateTo`

Сортировка передаётся в формате `field:dir`.

`companyId` **принудительно удаляется** из параметров перед отправкой запроса.

---

### Получение сделки
- `getDealById(dealId)` → `GET /deals/:id`

---

### Создание сделки
- `createDeal(payload)` → `POST /deals`

`companyId` удаляется из payload на стороне клиента.

---

### Обновление сделки
- `updateDeal({ dealId, payload })` → `PUT /deals/:id`

`companyId` удаляется из payload.

---

### Удаление / архивирование
- `deleteDeal(dealId)` → `DELETE /deals/:id`

---

### Изменение статуса
- `markWon(dealId)` → `PUT /deals/:id` с `{ status: 'won' }`
- `markLost(dealId)` → `PUT /deals/:id` с `{ status: 'lost' }`

---

## UI‑структура

### Список сделок (`/main/deals`)
- Заголовок страницы: **«Сделки»** + кнопка **«+ Новая сделка»**
- Панель фильтров:
  - Поиск (`q`)
  - Воронка (Pipeline)
  - Стадия (Stage)
  - Ответственный (Owner)
  - Статус
  - Диапазон дат
- Табличный вид (ListPage / DataTable):
  - Колонки: Название, Сумма, Статус, Ответственный, Обновлено
  - Действия строки: Открыть / Won / Lost
- Пагинация через ListPage
- Модальное окно **«Новая сделка»** с минимальным набором полей

---

### Карточка сделки (`/main/deals/:id`)
- Верхняя панель:
  - хлебные крошки
  - название сделки
  - действия: Редактировать, Сохранить, Won, Lost, Архивировать
- Быстрая панель:
  - выбор стадии
  - сумма
  - дата закрытия (только для чтения)
- Вкладки:
  - **Обзор** — реальные данные и режим редактирования
  - **Активности** — скоро
  - **Файлы** — скоро
  - **История** — скоро
- Правая боковая панель:
  - Ответственный
  - Контрагент
  - Контакты
  - Дата создания
  - Дата обновления

---

## Состояния интерфейса
- **Загрузка**:
  - список — строки загрузки
  - карточка — skeleton‑заглушка
- **Пустой список** — «Ничего не найдено»
- **Не найдено** — «Сделка не найдена»
- **Нет доступа** — «Недостаточно прав»

---

## Критерии приёмки
- На страницах сделок отсутствуют HTTP‑вызовы вне store.
- `companyId` не передаётся в URL, query или body со стороны клиента.
- Реализованы маршруты:
  - `/main/deals`
  - `/main/deals/:id`
- Действия над строками обновляют данные без перезагрузки страницы.
- Повторяющиеся UI‑блоки вынесены в `components/shared`.
