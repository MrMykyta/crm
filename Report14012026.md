# Аналитический аудит CRM (без кода)

## 1. Структура проекта

### server/
```
server/
  app.js                 # Инициализация Express, middleware, маршруты, error handler, cron, Mongo
  index.js               # HTTP server + socket.io
  boot/                  # cron bootstrap
  jobs/                  # фоновые джобы
  scripts/               # утилиты (scaffold, testChat)
  uploads/               # файлы (storage для upload/attachment)
  upload/                # локальное хранение (storage.js)
  src/
    acl/                 # ACL логика
    config/              # Sequelize/Mongo конфиги
    constants/           # permissions + ACL defaults
    controllers/         # HTTP контроллеры (crm/pim/wms/oms/system)
    db/                  # Mongo connection
    errors/              # кастомные ошибки
    http/                # .http примеры запросов
    lib/                 # вспомогательные libs (sseHub)
    middleware/          # auth/authorize/validation
    migrations/          # Sequelize миграции
    models/              # Sequelize модели (crm/pim/wms/oms/system)
    mongoModels/         # Mongo модели (chat)
    routes/              # Express routers (crm/pim/wms/oms/system)
    schemas/             # Joi схемы (валидация)
    services/            # бизнес-логика
    socket/              # socket.io (chat)
    utils/               # helpers (pagination, withCompany, tokenService)
```

### client/
```
client/
  public/                # публичные ассеты
  build/                 # сборка (если есть)
  src/
    App.js               # маршрутизация
    pages/               # страницы (роуты)
    components/          # переиспользуемый UI
    store/               # Redux slices + RTK Query + realtime
    hooks/               # hooks
    sockets/             # socket.io client
    utils/               # helpers
    schemas/             # yup схемы
    styles/              # base/styles
    Providers/           # Theme/Topbar providers
    i18n/                # локализация
    config/              # меню, виджеты, опции
```

## 2. Backend — инвентаризация

### 2.1 Sequelize Models (все модели)

#### CRM
- Company (`server/src/models/crm/company.js`) — компания/tenant; поля: id, name, nip, regon, krs, bdo, website, street, postalCode, city, country, description, ownerUserId, avatarUrl, createdAt, updatedAt; связи: belongsTo User as owner (fk ownerUserId), hasMany UserCompany as memberships (fk companyId), belongsToMany User as users through UserCompany (fk companyId/otherKey userId), hasMany ContactPoint as contacts (ownerType=company), hasMany Contact as people (fk companyId), hasMany UserPermission as userPermissions; companyId: нет (root-tenant); используется: `server/src/services/crm/companyService.js`, `server/src/services/crm/userService.js`, `server/src/controllers/crm/Company.controller.js`, `server/src/controllers/system/Invitation.controller.js`.
- CompanyDepartment (`server/src/models/crm/companydepartment.js`) — отдел компании; поля: id, companyId, name, description, createdAt, updatedAt; связи: belongsTo Company as company (fk companyId), hasMany UserCompany as members (fk departmentId), belongsToMany Task as tasks through task_department_participants (fk departmentId/otherKey taskId); companyId: да; используется: `server/src/services/crm/depatmentService.js`, `server/src/services/crm/userCompanyService.js`, `server/src/services/crm/taskService.js`, `server/src/controllers/crm/Department.controller.js`.
- Contact (`server/src/models/crm/contact.js`) — контактное лицо; поля: id, companyId, counterpartyId, mainResponsibleUserId, firstName, lastName, middleName, displayName, jobTitle, department, status, isPrimary, notes, createdBy, updatedBy, createdAt, updatedAt, deletedAt; связи: belongsTo Company as company (fk companyId), belongsTo Counterparty as counterparty (fk counterpartyId), belongsTo User as responsible (fk mainResponsibleUserId), belongsTo User as creator (fk createdBy), belongsTo User as updater (fk updatedBy), hasMany ContactPoint as contactPoints (ownerType=contact); companyId: да; используется: `server/src/services/crm/contactService.js`, `server/src/controllers/crm/Contact.controller.js`.
- ContactPoint (`server/src/models/crm/contactpoint.js`) — контактная точка (email/phone/…); поля: id, companyId, ownerType, ownerId, channel, valueRaw, valueNorm, label, isPrimary, isPublic, verifiedAt, notes, createdBy, createdAt, updatedAt, deletedAt; связи: belongsTo Company as company (fk companyId), belongsTo User as creator (fk createdBy), belongsTo Counterparty as counterparty (fk ownerId), belongsTo Contact as ownerContact (fk ownerId), belongsTo User as ownerUser (fk ownerId), belongsTo Company as ownerCompany (fk ownerId); companyId: да; используется: `server/src/services/crm/contactPointService.js`, `server/src/controllers/crm/СontactPoint.controller.js`, также в `server/src/services/crm/counterpartyService.js`, `server/src/services/crm/contactService.js`, `server/src/services/crm/userService.js`.
- Counterparty (`server/src/models/crm/counterparty.js`) — контрагент/лид/клиент; поля: id, companyId, holdingId, departmentId, mainResponsibleUserId, firstName, lastName, fullName, shortName, nip, regon, krs, bdo, type, status, country, city, postalCode, street, isCompany, description, avatarUrl, createdBy, updatedBy, createdAt, updatedAt; связи: belongsTo Company as company (fk companyId), belongsTo User as responsible/creator/updater, belongsTo Counterparty as holding, hasMany Counterparty as subsidiaries, hasMany ContactPoint as contacts (ownerType=counterparty), hasMany Contact as people (fk counterpartyId); companyId: да; используется: `server/src/services/crm/counterpartyService.js`, `server/src/controllers/crm/Counterparty.controller.js`, также в `server/src/services/crm/dealService.js`, `server/src/services/crm/taskService.js`.
- CrmPipeline (`server/src/models/crm/crmpipeline.js`) — воронка продаж; поля: id, companyId, name, description, isDefault, createdAt, updatedAt, deletedAt; связи: belongsTo Company as company (fk company_id), hasMany CrmPipelineStage as stages (fk pipeline_id); companyId: да; используется: `server/src/services/crm/pipelineService.js`, `server/src/controllers/crm/Pipeline.controller.js` (router не подключен).
- CrmPipelineStage (`server/src/models/crm/crmpipelinestage.js`) — этап воронки; поля: id, companyId, pipelineId, name, probability, position, color, createdAt, updatedAt; связи: belongsTo Company as company (fk company_id), belongsTo CrmPipeline as pipeline (fk pipeline_id); companyId: да; используется: `server/src/services/crm/pipelineService.js`.
- Deal (`server/src/models/crm/deal.js`) — сделка; поля: id, companyId, counterpartyId, title, description, status, value, currency, responsibleId, createdBy, updatedBy, pipelineId, stageId, stageEnteredAt, createdAt, updatedAt; связи: belongsTo Company as company (fk companyId), belongsTo Counterparty as counterparty (fk counterpartyId), belongsTo User as responsible (fk responsibleId), hasMany Task as tasks (fk dealId); companyId: да; используется: `server/src/services/crm/dealService.js`, `server/src/controllers/crm/Deal.controller.js`.
- Note (`server/src/models/crm/note.js`) — заметка; поля: id, companyId, ownerType, ownerId, createdBy, updatedBy, responsibleId, visibility, content, pinned, createdAt, updatedAt; связи: belongsTo Company (fk companyId), belongsTo User as author (fk authorUserId); companyId: да; используется: `server/src/services/crm/noteService.js`, `server/src/controllers/crm/Note.controller.js`.
- Permission (`server/src/models/crm/permission.js`) — справочник прав; поля: id, name, description; связи: belongsToMany Role as roles through RolePermission (fk permissionId), belongsToMany User as users through UserPermission (fk permissionId); companyId: нет (глобально); используется: `server/src/services/system/aclService.js`, `server/src/services/system/aclBootstrap.js`, `server/src/services/crm/userService.js`, `server/src/controllers/system/Acl.controller.js`.
- Role (`server/src/models/crm/role.js`) — ACL-роль внутри компании; поля: id, companyId, name, description; связи: belongsTo Company as company (fk companyId), belongsToMany Permission as permissions through RolePermission (fk roleId), belongsToMany User as users through UserRole (fk roleId), hasMany UserRole as userRoles; companyId: да; используется: `server/src/services/system/aclService.js`, `server/src/services/system/aclBootstrap.js`, `server/src/services/crm/userService.js`.
- RolePermission (`server/src/models/crm/rolepermission.js`) — связь role↔permission; поля: roleId, permissionId, createdAt, updatedAt; связи: belongsTo Role as role, belongsTo Permission as permission; companyId: нет (join через Role); используется: `server/src/services/system/aclService.js`, `server/src/services/system/aclBootstrap.js`.
- Task (`server/src/models/crm/task.js`) — задача; поля: id, companyId, createdBy, title, category, description, status, priority, startAt, endAt, timezone, participantMode, watcherMode, statusAggregate, counterpartyId, dealId, createdAt, updatedAt, deletedAt; связи: belongsTo Company as company (fk companyId), belongsTo User as creator (fk createdBy), belongsTo Counterparty as counterparty (fk counterpartyId), belongsTo Deal as deal (fk dealId), belongsToMany User as userParticipants through TaskUserParticipant (fk taskId/otherKey userId), belongsToMany CompanyDepartment as departmentParticipants through TaskDepartmentParticipant (fk taskId/otherKey departmentId), belongsToMany Contact as contacts through TaskContact (fk taskId/otherKey contactId); companyId: да; используется: `server/src/services/crm/taskService.js`, `server/src/controllers/crm/Task.controller.js`.
- TaskContact (`server/src/models/crm/taskcontact.js`) — связь task↔contact; поля: id, taskId, contactId, createdAt, updatedAt; связи: belongsTo Task as task, belongsTo Contact as contact; companyId: нет (через Task); используется: `server/src/services/crm/taskService.js`.
- TaskDepartmentParticipant (`server/src/models/crm/taskdepartmentparticipant.js`) — связь task↔department; поля: id, taskId, departmentId, createdAt, updatedAt; связи: не описаны; companyId: нет (через Task); используется: `server/src/services/crm/taskService.js`.
- TaskUserParticipant (`server/src/models/crm/taskuserparticipant.js`) — связь task↔user; поля: id, taskId, userId, role, memberStatus, createdAt, updatedAt; связи: не описаны; companyId: нет (через Task); используется: `server/src/services/crm/taskService.js`.
- User (`server/src/models/crm/user.js`) — пользователь; поля: id, email, passwordHash, firstName, lastName, isActive, lastLoginAt, verificationToken, verificationExpiresAt, emailVerifiedAt, avatarUrl, backgroundUrl, createdBy, createdAt, updatedAt; связи: hasMany Company as owned_companies, hasMany UserCompany as memberships, belongsToMany Company as companies through UserCompany, hasMany ContactPoint as contacts (ownerType=user), belongsToMany Role as roles through UserRole, hasMany UserRole as userRoles, belongsToMany Permission as permissions through UserPermission, hasMany UserPermission as userPermissions, belongsToMany Task as assignedTasks through task_user_participants, hasMany Contact as responsibleContacts; companyId: нет (глобально); используется: `server/src/services/crm/userService.js`, `server/src/services/system/authService.js`, `server/src/controllers/crm/User.controller.js`, `server/src/controllers/system/Acl.controller.js`, `server/src/services/system/chat/chatService.js`.
- UserCompany (`server/src/models/crm/usercompany.js`) — членство пользователя в компании; поля: id, userId, companyId, role, status, departmentId, isLead, joinedAt, deletedAt, createdAt, updatedAt; связи: belongsTo User as user, belongsTo Company as company, belongsTo CompanyDepartment as department; companyId: да; используется: `server/src/services/crm/userCompanyService.js`, `server/src/services/crm/companyService.js`, `server/src/services/crm/userService.js`, `server/src/services/system/invitationService.js`.
- UserPermission (`server/src/models/crm/userpermission.js`) — пользовательские оверрайды прав; поля: userId, permissionId, companyId, effect; связи: belongsTo User as user, belongsTo Company as company, belongsTo Permission as permission; companyId: да; используется: `server/src/services/system/aclService.js`, `server/src/middleware/permissionResolver.js`.
- UserRole (`server/src/models/crm/userrole.js`) — связь user↔role; поля: userId, companyId, roleId; связи: belongsTo User as user, belongsTo Role as role, belongsTo Company as company; companyId: да; используется: `server/src/services/system/aclService.js`, `server/src/services/crm/userService.js`.

#### System
- Attachments (`server/src/models/system/attachments.js`) — вложения; поля: id, companyId, ownerType, ownerId, filename, mime, size, storagePath, uploadedBy, createdAt, updatedAt; связи: не заданы; companyId: да; используется: `server/src/services/system/attachmentService.js` (но сервис импортирует `Attachment` вместо `Attachments`).
- RefreshToken (`server/src/models/system/refreshtoken.js`) — refresh токены; поля: id, userId, jti, revokedAt, replacedBy, expiresAt, userAgent, ip, createdAt, updatedAt; связи: belongsTo User as user; companyId: нет (user-level); используется: `server/src/utils/tokenService.js`.
- Sequence (`server/src/models/system/sequence.js`) — номера/счётчики; поля: id, companyId, scope, year, value; связь: belongsTo Company; companyId: да; используется: `server/src/services/system/numberingService.js`.
- SystemEvent (`server/src/models/system/systemevent.js`) — события; поля: id, companyId, type, entityType, entityId, payload, createdAt; связь: belongsTo Company as company; companyId: да; используется: `server/src/services/system/eventService.js`.
- SystemJob (`server/src/models/system/systemjob.js`) — фоновые задания; поля: id, companyId, name, payload, status, runAt, createdAt, updatedAt; связи: belongsTo Company as company, hasMany SystemJobRun as runs; companyId: да.
- SystemJobRun (`server/src/models/system/systemjobrun.js`) — прогоны jobs; поля: id, companyId, jobId, status, startedAt, finishedAt, errorMessage; связи: belongsTo Company as company, belongsTo SystemJob as job; companyId: да.
- SystemTrigger (`server/src/models/system/systemtrigger.js`) — триггеры workflow; поля: id, companyId, workflowId, type, config, createdAt, updatedAt; связи: belongsTo Company as company, belongsTo SystemWorkflow as workflow; companyId: да.
- SystemWebhook (`server/src/models/system/systemwebhook.js`) — webhooks; поля: id, companyId, name, url, secret, isActive, eventFilters, createdAt, updatedAt, deletedAt; связи: belongsTo Company as company, hasMany SystemWebhookDelivery as deliveries; companyId: да.
- SystemWebhookDelivery (`server/src/models/system/systemwebhookdelivery.js`) — доставки webhook; поля: id, companyId, webhookId, eventId, status, attempt, nextAttemptAt, responseCode, errorMessage, createdAt, updatedAt; связи: belongsTo Company as company, belongsTo SystemWebhook as webhook, belongsTo SystemEvent as event; companyId: да.
- SystemWorkflow (`server/src/models/system/systemworkflow.js`) — workflow; поля: id, companyId, name, isActive, definition, createdAt, updatedAt, deletedAt; связи: belongsTo Company as company, hasMany SystemTrigger as triggers; companyId: да.
- UserPreferences (`server/src/models/system/userpreferences.js`) — настройки пользователя; поля: id, userId, language, themeMode, customTheme, appearance, background; связь: belongsTo User as user; companyId: нет (user-level); используется: `server/src/services/system/userPreferencesService.js`.

#### Top-level
- Invitation (`server/src/models/invitation.js`) — инвайты; поля: id, companyId, email, firstName, lastName, role, invitedBy, token, expiresAt, acceptedAt, status; связи: belongsTo Company as company, belongsTo User as inviter; companyId: да; используется: `server/src/services/system/invitationService.js`, `server/src/controllers/system/Invitation.controller.js`.
- Notification (`server/src/models/notifications.js`) — уведомления; поля: id, companyId, userId, type, title, body, entityType, entityId, meta, isRead, createdAt, updatedAt; связи: belongsTo Company as company, belongsTo User as user; companyId: да; используется: `server/src/services/system/notificationService.js`, `server/src/controllers/system/Notification.controller.js`.
- PasswordResetTokens (`server/src/models/passwordresettokens.js`) — токены сброса пароля; поля: userId, tokenHash, expiresAt, usedAt, ip, userAgent; связь: belongsTo User as user; companyId: нет (user-level); используется: `server/src/services/system/passwordResetService.js`.

#### PIM
- Attribute (`server/src/models/pim/attribute.js`) — атрибут товара; поля: id, companyId, code, name, type, isRequired, isVariant, unit; связи: belongsTo Company as company, hasMany AttributeOption as options, hasMany ProductAttributeValue as values; companyId: да; используется: `server/src/services/pim/attributeService.js`, `server/src/controllers/pim/attribute.controller.js`.
- AttributeOption (`server/src/models/pim/attributeoption.js`) — опции атрибута; поля: id, companyId, attributeId, value, sortOrder; связи: belongsTo Company as company, belongsTo Attribute as attribute; companyId: да; используется: `server/src/services/pim/attributeOptionService.js`, `server/src/controllers/pim/attributeOption.controller.js`.
- Brand (`server/src/models/pim/brand.js`) — бренд; поля: id, companyId, name, slug, description, logoUrl, isActive; связи: belongsTo Company as company, hasMany Product as products; companyId: да; используется: `server/src/services/pim/brandService.js`, `server/src/controllers/pim/brand.controller.js`.
- Category (`server/src/models/pim/category.js`) — категория; поля: id, companyId, parentId, name, slug, path, description, isActive, sortOrder; связи: belongsTo Company as company, belongsTo Category as parent, hasMany Category as children, belongsToMany Product as products through ProductCategory; companyId: да; используется: `server/src/services/pim/categoryService.js`, `server/src/controllers/pim/category.controller.js`.
- Channel (`server/src/models/pim/channel.js`) — канал продаж; поля: id, companyId, code, name, type, isActive, createdAt, updatedAt; связи: belongsTo Company as company, hasMany ChannelListing as listings, hasMany ChannelCategoryMap as categoryMaps; companyId: да; используется: `server/src/services/pim/channelService.js`, `server/src/services/pim/channelService.extras.js`, `server/src/controllers/pim/channel.controller.js`.
- ChannelCategoryMap (`server/src/models/pim/channelcategorymap.js`) — маппинг категорий каналов; поля: id, companyId, channelId, categoryId, externalCategoryId, externalPath; связи: belongsTo Channel as channel, belongsTo Category as category; companyId: да; используется: `server/src/services/pim/channelCategoryMapService.js`, `server/src/controllers/pim/channelCategoryMap.controller.js`.
- ChannelListing (`server/src/models/pim/channellisting.js`) — публикация товара в канале; поля: id, companyId, channelId, productId, variantId, state, channelSku, currency, price, title, description, data; связи: belongsTo Channel as channel, belongsTo Product as product, belongsTo ProductVariant as variant; companyId: да; используется: `server/src/services/pim/channelListingService.js`, `server/src/controllers/pim/channelListing.controller.js`.
- Collection (`server/src/models/pim/collection.js`) — коллекции; поля: id, companyId, code, name, description, isActive; связи: belongsTo Company as company, belongsToMany Product as products through ProductCollection; companyId: да; используется: `server/src/services/pim/collectionService.js`, `server/src/controllers/pim/collection.controller.js`.
- PackagingUnit (`server/src/models/pim/packagingunit.js`) — упаковочные единицы; поля: id, companyId, productId, variantId, level, quantity, gtin14, weight, length, width, height, uomId; связи: belongsTo Product as product, belongsTo ProductVariant as variant, belongsTo Uom as uom; companyId: да; используется: `server/src/services/pim/packagingUnitService.js`, `server/src/controllers/pim/packagingUnit.controller.js`.
- PriceList (`server/src/models/pim/pricelist.js`) — прайс-листы; поля: id, companyId, code, name, currency, type, isActive, startAt, endAt; связи: belongsTo Company as company, hasMany PriceListItem as items; companyId: да; используется: `server/src/services/pim/priceListService.js`, `server/src/controllers/pim/priceList.controller.js`.
- PriceListItem (`server/src/models/pim/pricelistitem.js`) — элементы прайса; поля: id, companyId, priceListId, productId, variantId, minQty, price; связи: belongsTo PriceList as priceList, belongsTo Product as product, belongsTo ProductVariant as variant; companyId: да; используется: `server/src/services/pim/priceListItemService.js`, `server/src/controllers/pim/priceListItem.controller.js`.
- Product (`server/src/models/pim/product.js`) — товар; поля: id, companyId, brandId, primaryCategoryId, uomId, sku, name, slug, barcode, description, status, visibility, currency, price, oldPrice, cost, weight, length, width, height, trackInventory, publishedAt, productTypeId, taxCategoryId, shippingClassId, hsCode, countryOfOrigin, warrantyMonths, dangerousGoodsClass, unNumber, isSerialized, isLotTracked, shelfLifeDays, discontinuedAt, replacedByProductId; связи: belongsTo Company as company, Brand as brand, Category as primaryCategory, Uom as uom, ProductType as type, TaxCategory as taxCategory, ShippingClass as shippingClass, Product as replacement; belongsToMany Category as categories through ProductCategory; hasMany ProductVariant as variants, ProductAttributeValue as attributes, ProductLocalization as localizations, ProductSupplier as suppliers, ProductExternalRef as externalRefs, PackagingUnit as packaging, ProductComponent as components, ProductRelation as relations; belongsToMany Attachments as attachments through ProductAttachment; belongsToMany Tag as tags through ProductTag; belongsToMany Collection as collections through ProductCollection; companyId: да; используется: `server/src/services/pim/productService.js`.
- ProductAttachment (`server/src/models/pim/productattachment.js`) — связь товар↔вложение; поля: id, companyId, productId, attachmentId, role, sortOrder; связи: belongsTo Product, belongsTo Attachments (alias не задан); companyId: да; используется: `server/src/services/pim/productAttachmentService.js`, `server/src/controllers/pim/productAttachment.controller.js`.
- ProductAttributeValue (`server/src/models/pim/productattributevalue.js`) — значения атрибутов; поля: id, companyId, productId, attributeId, valueText, valueNumber, valueBoolean, valueDate, valueJson; связи: belongsTo Product as product, belongsTo Attribute as attribute; companyId: да; используется: `server/src/services/pim/productAttributeValueService.js`, `server/src/controllers/pim/productAttributeValue.controller.js`.
- ProductCategory (`server/src/models/pim/productcategory.js`) — связь товар↔категория; поля: id, companyId, productId, categoryId; связи: belongsTo Product, belongsTo Category (alias не задан); companyId: да; используется: `server/src/services/pim/productCategoryService.js`, `server/src/controllers/pim/productCategory.controller.js`.
- ProductCollection (`server/src/models/pim/productcollection.js`) — связь товар↔коллекция; поля: id, companyId, productId, collectionId, sortOrder; связи: belongsTo Product, belongsTo Collection (alias не задан); companyId: да; используется: `server/src/services/pim/productCollectionService.js`, `server/src/controllers/pim/productCollection.controller.js`.
- ProductComponent (`server/src/models/pim/productcomponent.js`) — компоненты/комплекты; поля: id, companyId, parentProductId, componentProductId, componentVariantId, quantity, allowSubstitute; связи: belongsTo Product as parent, belongsTo Product as componentProduct, belongsTo ProductVariant as componentVariant; companyId: да; используется: `server/src/services/pim/productComponentService.js`, `server/src/controllers/pim/productComponent.controller.js`.
- ProductExternalRef (`server/src/models/pim/productexternalref.js`) — внешние ссылки; поля: id, companyId, productId, variantId, system, externalId, data; связи: belongsTo Product as product, belongsTo ProductVariant as variant; companyId: да; используется: `server/src/services/pim/productExternalRefService.js`, `server/src/controllers/pim/productExternalRef.controller.js`.
- ProductLocalization (`server/src/models/pim/productlocalization.js`) — локализации; поля: id, companyId, productId, locale, slug, name, shortDescription, longDescription, seoTitle, seoDescription, seoKeywords; связь: belongsTo Product as product; companyId: да; используется: `server/src/services/pim/productLocalizationService.js`, `server/src/controllers/pim/productLocalization.controller.js`.
- ProductRelation (`server/src/models/pim/productrelation.js`) — связи товаров; поля: id, companyId, sourceProductId, targetProductId, relationType; связи: belongsTo Product as source, belongsTo Product as target; companyId: да; используется: `server/src/services/pim/productRelationService.js`, `server/src/controllers/pim/productRelation.controller.js`.
- ProductSupplier (`server/src/models/pim/productsupplier.js`) — поставщики товара; поля: id, companyId, productId, variantId, supplierId, supplierSku, currency, price, moq, leadTimeDays, packSize, url; связи: belongsTo Product as product, belongsTo ProductVariant as variant, belongsTo Counterparty as supplier; companyId: да; используется: `server/src/services/pim/productSupplierService.js`, `server/src/controllers/pim/productSupplier.controller.js`.
- ProductTag (`server/src/models/pim/producttag.js`) — связь товар↔тег; поля: id, companyId, productId, tagId; связи: belongsTo Product, belongsTo Tag (alias не задан); companyId: да; используется: `server/src/services/pim/productTagService.js`, `server/src/controllers/pim/productTag.controller.js`.
- ProductType (`server/src/models/pim/producttype.js`) — тип товара; поля: id, companyId, code, name, description, isActive; связи: belongsTo Company as company, hasMany ProductTypeAttribute as attributes, hasMany Product as products; companyId: да; используется: `server/src/services/pim/productTypeService.js`, `server/src/controllers/pim/productType.controller.js`.
- ProductTypeAttribute (`server/src/models/pim/producttypeattribute.js`) — связь тип↔атрибут; поля: id, companyId, productTypeId, attributeId, isRequired, isVariant, sortOrder; связи: belongsTo ProductType as type, belongsTo Attribute as attribute; companyId: да; используется: `server/src/services/pim/productTypeService.js`.
- ProductVariant (`server/src/models/pim/productvariant.js`) — варианты товара; поля: id, companyId, productId, sku, barcode, currency, price, cost, uomId, weight, length, width, height, isActive; связи: belongsTo Product as product, belongsTo Uom as uom, hasMany VariantOption as options; companyId: да; используется: `server/src/services/pim/productVariantService.js`, `server/src/controllers/pim/productVariant.controller.js`.
- ShippingClass (`server/src/models/pim/shippingclass.js`) — классы доставки; поля: id, companyId, code, name, isActive; связи: belongsTo Company as company, hasMany Product as products; companyId: да; используется: `server/src/services/pim/shippingClassService.js`, `server/src/controllers/pim/shippingClass.controller.js`.
- Tag (`server/src/models/pim/tag.js`) — теги; поля: id, companyId, code, name, isActive; связи: belongsTo Company as company, belongsToMany Product as products through ProductTag; companyId: да; используется: `server/src/services/pim/tagService.js`, `server/src/controllers/pim/tag.controller.js`.
- TaxCategory (`server/src/models/pim/taxcategory.js`) — налоговые категории; поля: id, companyId, code, name, rate, isActive; связи: belongsTo Company as company, hasMany Product as products; companyId: да; используется: `server/src/services/pim/taxCategoryService.js`, `server/src/controllers/pim/taxCategory.controller.js`.
- Uom (`server/src/models/pim/uom.js`) — единицы измерения; поля: id, companyId, code, name, precision, isActive; связи: belongsTo Company as company, hasMany Product as products, hasMany ProductVariant as variants; companyId: да; используется: `server/src/services/pim/uomService.js`, `server/src/controllers/pim/uom.controller.js`.
- VariantOption (`server/src/models/pim/variantoption.js`) — опции варианта; поля: id, companyId, variantId, name, value, sortOrder; связь: belongsTo ProductVariant as variant; companyId: да; используется: `server/src/services/pim/variantOptionService.js`, `server/src/controllers/pim/variantOption.controller.js`.

#### OMS
- Coupon (`server/src/models/oms/coupon.js`) — купоны; поля: id, companyId, code, promotionId, usageLimit, usedCount, validFrom, validTo; связи: belongsTo Company as company, belongsTo Promotion as promotion; companyId: да; используется: `server/src/services/oms/offerService.js`.
- CreditNote (`server/src/models/oms/creditnote.js`) — кредит-нота; поля: id, companyId, invoiceId, amountNet, amountTax, amountGross, reason; связи: belongsTo Company as company, belongsTo Invoice as invoice; companyId: да; используется: `server/src/services/oms/invoiceService.js`.
- Discount (`server/src/models/oms/discount.js`) — скидки; поля: id, companyId, ownerType, ownerId, type, amountNet, amountGross, metaJson; связи: belongsTo Company as company, belongsTo Offer as offer, OfferItem as offerItem, Order as order, OrderItem as orderItem (по ownerId); companyId: да; используется: `server/src/services/oms/offerService.js`, `server/src/services/oms/orderService.js`.
- Invoice (`server/src/models/oms/invoice.js`) — счета; поля: id, companyId, orderId, number, issueDate, dueDate, paidDate, totalNet, totalTax, totalGross; связи: belongsTo Company as company, belongsTo Order as order, hasMany CreditNote as creditNotes; companyId: да; используется: `server/src/services/oms/invoiceService.js`, `server/src/controllers/oms/Invoice.controller.js`.
- Offer (`server/src/models/oms/offer.js`) — предложения; поля: id, companyId, customerId, currencyCode, status, validUntil, totalNet, totalTax, totalGross, createdAt, updatedAt; связи: belongsTo Company as company, belongsTo Counterparty as customer, hasMany OfferItem as items, hasMany Discount as discounts, hasMany Order as orders; companyId: да; используется: `server/src/services/oms/offerService.js`, `server/src/controllers/oms/Offer.controller.js`.
- OfferItem (`server/src/models/oms/offeritem.js`) — позиции предложения; поля: id, offerId, variantId, uomId, sku, nameSnapshot, qty, priceNet, priceGross, taxRate, discountAmount; связи: belongsTo Offer as offer, belongsTo ProductVariant as variant, belongsTo Uom as uom, hasMany Discount as discounts; companyId: нет (через Offer); используется: `server/src/services/oms/offerService.js`.
- Order (`server/src/models/oms/order.js`) — заказы; поля: id, companyId, offerId, customerId, salesChannelId, shippingClassId, currencyCode, status, paymentStatus, fulfillmentStatus, placedAt, confirmedAt, shippedAt, completedAt, cancelledAt, totalNet, totalTax, totalGross; связи: belongsTo Company as company, Offer as offer, Counterparty as customer, ShippingClass as shippingClass, Channel as salesChannel, hasMany OrderItem as items, Payment as payments, Invoice as invoices, Shipment as shipments, OrderEvent as events, OrderNote as notes, Discount as discounts; companyId: да; используется: `server/src/services/oms/orderService.js`, `server/src/controllers/oms/Order.controller.js`.
- OrderEvent (`server/src/models/oms/orderevent.js`) — события заказа; поля: id, companyId, orderId, actorId, type, message; связи: belongsTo Company as company, belongsTo Order as order, belongsTo User as actor; companyId: да; используется: `server/src/services/oms/orderService.js`.
- OrderItem (`server/src/models/oms/orderitem.js`) — позиции заказа; поля: id, companyId, orderId, variantId, uomId, sku, nameSnapshot, qty, priceNet, priceGross, taxRate, discountAmount, priceListItemId; связи: belongsTo Order as order, ProductVariant as variant, Uom as uom, PriceListItem as priceListItem, hasMany Discount as discounts, hasMany Reservation as reservations; companyId: да; используется: `server/src/services/oms/orderService.js`.
- OrderNote (`server/src/models/oms/ordernote.js`) — заметки заказа; поля: id, companyId, orderId, authorId, note; связи: belongsTo Company as company, Order as order, User as author; companyId: да; используется: `server/src/services/oms/orderService.js`.
- Package (`server/src/models/oms/package.js`) — упаковки/посылки; поля: id, companyId, shipmentId, weight, dimensionsJson, trackingNumber; связи: belongsTo Company as company, belongsTo Shipment as shipment; companyId: да; используется: `server/src/services/oms/orderService.js`.
- Payment (`server/src/models/oms/payment.js`) — платежи; поля: id, companyId, orderId, method, status, amount, transactionId, processedAt; связи: belongsTo Company as company, belongsTo Order as order; companyId: да; используется: `server/src/services/oms/paymentService.js`, `server/src/controllers/oms/Payment.controller.js`.
- Promotion (`server/src/models/oms/promotion.js`) — промо; поля: id, companyId, type, value, conditionsJson, validFrom, validTo; связи: belongsTo Company as company, hasMany Coupon as coupons; companyId: да; используется: `server/src/services/oms/offerService.js`.

#### WMS
- Adjustment (`server/src/models/wms/adjustment.js`) — инвентарная корректировка; поля: id, companyId, warehouseId, reason; связи: hasMany AdjustmentItem as items (fk adjustment_id); companyId: да; используется: `server/src/services/wms/adjustmentService.js`.
- AdjustmentItem (`server/src/models/wms/adjustmentitem.js`) — строка корректировки; поля: id, adjustmentId, productId, variantId, locationId, lotId, serialId, qtyDelta; связи: нет; companyId: нет (через Adjustment); используется: `server/src/services/wms/adjustmentItemService.js`, `server/src/controllers/wms/adjustmentItem.controller.js`.
- CountItem (`server/src/models/wms/countitem.js`) — строка пересчета; поля: id, countId, locationId, productId, variantId, lotId, serialId, qtyCounted; связи: нет; companyId: нет (через CycleCount); используется: `server/src/services/wms/countItemService.js`.
- CycleCount (`server/src/models/wms/cyclecount.js`) — циклическая инвентаризация; поля: id, companyId, warehouseId, status; связи: hasMany CountItem as items (fk count_id); companyId: да; используется: `server/src/services/wms/cycleCountService.js`, `server/src/controllers/wms/cycleCount.controller.js`.
- InventoryItem (`server/src/models/wms/inventoryitem.js`) — остаток на складе; поля: id, companyId, warehouseId, locationId, productId, variantId, lotId, serialId, qtyOnHand, qtyReserved; связи: belongsTo Location as location (fk location_id), belongsTo Warehouse as warehouse (fk warehouse_id); companyId: да; используется: `server/src/services/wms/inventoryItemService.js`, `server/src/controllers/wms/inventoryItem.controller.js`, `server/src/services/wms/inventoryService.js`.
- Location (`server/src/models/wms/location.js`) — ячейка склада; поля: id, companyId, warehouseId, code, type; связь: belongsTo Warehouse as warehouse (fk warehouse_id); companyId: да; используется: `server/src/services/wms/locationService.js`, `server/src/controllers/wms/location.controller.js`.
- Lot (`server/src/models/wms/lot.js`) — партия; поля: id, companyId, productId, lotNumber, mfgDate, expDate; связи: нет; companyId: да; используется: `server/src/services/wms/lotService.js`, `server/src/controllers/wms/lot.controller.js`.
- Parcel (`server/src/models/wms/parcel.js`) — посылка; поля: id, shipmentId, carrier, trackingNumber, weight, dims; связи: нет; companyId: нет (через Shipment); используется: `server/src/services/wms/parcelService.js`, `server/src/controllers/wms/parcel.controller.js`.
- PickTask (`server/src/models/wms/picktask.js`) — задание на подбор; поля: id, waveId, orderId, productId, variantId, fromLocationId, toLocationId, qty, status; связи: нет; companyId: нет (через PickWave/Order); используется: `server/src/services/wms/pickTaskService.js`, `server/src/services/wms/pickService.js`.
- PickWave (`server/src/models/wms/pickwave.js`) — волна подбора; поля: id, companyId, warehouseId, status; связи: hasMany PickTask as tasks (fk wave_id); companyId: да; используется: `server/src/services/wms/pickWaveService.js`, `server/src/services/wms/pickService.js`.
- Receipt (`server/src/models/wms/receipt.js`) — приход; поля: id, companyId, warehouseId, number, status, inboundLocationId; связи: hasMany ReceiptItem as items (fk receipt_id); companyId: да; используется: `server/src/services/wms/receiptService.js`.
- ReceiptItem (`server/src/models/wms/receiptitem.js`) — строки прихода; поля: id, receiptId, productId, variantId, lotNumber, serialNumber, qtyExpected, qtyReceived; связи: нет; companyId: нет (через Receipt); используется: `server/src/services/wms/receiptItemService.js`, `server/src/controllers/wms/receiptItem.controller.js`.
- Reservation (`server/src/models/wms/reservation.js`) — резерв; поля: id, companyId, orderId, orderItemId, warehouseId, productId, variantId, qty, status; связи: нет; companyId: да; используется: `server/src/services/wms/reservationService.js`, `server/src/services/wms/inventoryService.js`.
- Serial (`server/src/models/wms/serial.js`) — серийные номера; поля: id, companyId, productId, serialNumber; связи: нет; companyId: да; используется: `server/src/services/wms/serialService.js`, `server/src/controllers/wms/serial.controller.js`.
- Shipment (`server/src/models/wms/shipment.js`) — отгрузка; поля: id, companyId, warehouseId, orderId, status; связи: hasMany ShipmentItem as items (fk shipment_id), hasMany Parcel as parcels (fk shipment_id); companyId: да; используется: `server/src/services/wms/shipmentService.js`.
- ShipmentItem (`server/src/models/wms/shipmentitem.js`) — строки отгрузки; поля: id, shipmentId, productId, variantId, qty; связи: нет; companyId: нет (через Shipment); используется: `server/src/services/wms/shipmentItemService.js`, `server/src/controllers/wms/shipmentItem.controller.js`.
- StockMove (`server/src/models/wms/stockmove.js`) — перемещения; поля: id, companyId, type, warehouseId, fromLocationId, toLocationId, productId, variantId, lotId, serialId, qty, refType, refId; связи: нет; companyId: да; используется: `server/src/services/wms/stockMoveService.js`, `server/src/services/wms/inventoryService.js`.
- TransferItem (`server/src/models/wms/transferitem.js`) — строки трансфера; поля: id, transferId, productId, variantId, lotId, serialId, qty; связи: нет; companyId: нет (через TransferOrder); используется: `server/src/services/wms/transferItemService.js`, `server/src/controllers/wms/transferItem.controller.js`.
- TransferOrder (`server/src/models/wms/transferorder.js`) — трансфер; поля: id, companyId, number, fromWarehouseId, toWarehouseId, status; связи: hasMany TransferItem as items (fk transfer_id); companyId: да; используется: `server/src/services/wms/transferOrderService.js`, `server/src/services/wms/transferService.js`.
- Warehouse (`server/src/models/wms/warehouse.js`) — склад; поля: id, companyId, code, name, isActive; связи: hasMany Location as locations (fk warehouse_id); companyId: да; используется: `server/src/services/wms/warehouseService.js`, `server/src/controllers/wms/warehouse.controller.js`.

### 2.2 Migrations
- Все таблицы из моделей имеют `createTable` миграции (по поиску `createTable` в `server/src/migrations`).
- Есть миграции изменения схемы: `add-department-and-is-lead-to-user-companies`, `add-user-email-verification`, `alter-products-add-column`, `deals-add-pipeline-stage`.
- Потенциальные несоответствия моделей/сервисов:
  - `ContactPointService` пишет `departmentId`, но поля нет в модели/миграции `contact_points` (`server/src/services/crm/contactPointService.js`, `server/src/models/crm/contactpoint.js`, `server/src/migrations/20250813130100-create-contact-point.js`).
  - `TaskService` фильтрует `User` по `companyId`, но в `User` нет этого поля (`server/src/services/crm/taskService.js`, `server/src/models/crm/user.js`).
  - `DealService` запрашивает `Task.dueDate`, но в `Task` поля нет (`server/src/services/crm/dealService.js`, `server/src/models/crm/task.js`).
  - `ProductService.upsertAttrs` использует alias `attributeValues`, а в модели `Product` алиас `attributes` (`server/src/services/pim/productService.js`, `server/src/models/pim/product.js`).
  - `AttachmentService` импортирует `Attachment`, а модель называется `Attachments` (`server/src/services/system/attachmentService.js`, `server/src/models/system/attachments.js`).

### 2.3 Routes / Controllers / Services

#### System
- Auth (`server/src/routes/system/authRouter.js` → `server/src/controllers/system/Auth.controller.js`)
  - POST `/auth/register` — регистрация; без authorize; ответ `{ ok, accessToken, refreshToken }`.
  - GET `/auth/verify` — подтверждение email; ответ `{ verified, tokens }`.
  - POST `/auth/resend-verification` — ресенд; ответ `{ ok }`.
  - POST `/auth/login` — логин; ответ `{ user, tokens, activeCompanyId }` или `{ data: { selectCompany, companies } }`.
  - POST `/auth/login-from-company` — смена компании (auth обязателен); ответ `{ safeUser, accessToken, refreshToken, activeCompanyId }`.
  - POST `/auth/refresh` — refresh; ответ `{ accessToken, refreshToken, user }`.
  - POST `/auth/password/forgot`, `/auth/password/reset` — сброс пароля; ответ `{ ok }`.
  - POST `/auth/logout` — revoke refresh; ответ `{ ok }`.
  - POST `/auth/logout-all` — revoke all; ответ `{ ok }`.
- ACL (`server/src/routes/system/aclRouter.js` → `server/src/controllers/system/Acl.controller.js`)
  - CRUD ролей/permissions + назначения пользователям; auth + `authorize('company:read'/'company:update')`; валидация через Joi (`server/src/schemas/roleSchema.js`, `server/src/schemas/permissionSchema.js`).
  - Ответы: raw объекты или `204`, без единого формата.
- Notifications (`server/src/routes/system/notificationRouter.js` → `server/src/controllers/system/Notification.controller.js`)
  - GET `/notifications` — список; POST `/:id/read`, POST `/read-all/all` — отметки; POST `/` — создание.
  - Проверки: только auth (в rootRouter), permissions не используются.
  - Ответы: `{ data }`, `{ ok: true }`, raw объект.
- Attachments (`server/src/routes/system/attachmentRouter.js` → `server/src/controllers/system/Attachment.controller.js`)
  - GET `/attachments` — list; POST `/attachments/upload` — upload; GET `/:id/download`; DELETE `/:id`.
  - Проверки: auth (в rootRouter), permissions не используются.
  - Ответы: raw `{rows,count}` от сервиса, объект или `{ ok: true }`.
  - Есть параллельный upload-роутер `/api/uploads` с отдельной логикой и без auth (`server/src/routes/system/uploadRouter.js`).
- Uploads (`server/src/routes/system/uploadRouter.js`, подключен как `/api/uploads` в `server/app.js`)
  - POST `/:ownerType/:ownerId` — upload; POST `/by-url/:ownerType/:ownerId` — attach by URL; GET `host`, `content-type`, `content-length`.
  - Проверки: нет auth; companyId берётся из body/query или из ownerId.
- Invitations (`server/src/routes/system/invitationsRouter.js` → `server/src/controllers/system/Invitation.controller.js`)
  - POST/GET `/companies/:companyId/invitations` — создание/список (auth).
  - POST `/:id/resend`, POST `/:id/revoke` (auth).
  - GET `/check`, POST `/accept` — публичные.
- User preferences (`server/src/routes/system/userPreferencesRouter.js` → `server/src/controllers/system/UserPreferences.controller.js`)
  - GET/PUT `/system/me/preferences` — prefs; auth; базовая валидация в контроллере.
- Webhooks (`server/src/routes/system/webhookRouter.js` → `server/src/controllers/system/Webhook.controller.js`)
  - CRUD `/webhooks`; auth; permissions не указаны.
- Workflow (`server/src/routes/system/workflowRouter.js` → `server/src/controllers/system/Wokflow.controller.js`)
  - CRUD `/workflow`; auth; permissions не указаны.
- Events (`server/src/routes/system/eventRouter.js` → `server/src/controllers/system/Event.controller.js`)
  - GET `/events` — list; auth; permissions не указаны.
- SSE (`server/src/routes/system/sseRouter.js`)
  - GET `/sse` — SSE по token+companyId в query; отдельная проверка токена, не auth middleware.
- Chat (`server/src/routes/system/chatRouter.js` → `server/src/controllers/system/chat/Chat.controller.js`)
  - Комнаты, сообщения, пины; auth; Mongo модели (`server/src/mongoModels/chat`).

#### CRM
- Company (`server/src/routes/crm/companyRouter.js` → `server/src/controllers/crm/Company.controller.js`)
  - GET `/companies` — список компаний пользователя.
  - GET `/companies/:id` — company scoped to `req.companyId`.
  - POST `/companies` — создание + выдача токенов.
  - PUT `/companies/:id`, DELETE `/companies/:id` — `authorize('compamy:update/delete')` (опечатка, не совпадает с `constants/permissions.js`).
  - Ответы: raw объекты; формат `{data,meta}` не используется.
- Users (`server/src/routes/crm/userRouter.js` → `server/src/controllers/crm/User.controller.js`)
  - GET `/users/me`, PATCH `/users/me`, GET `/users/me/companies`.
  - GET `/users/lookup` (auth).
  - GET/PATCH `/users/:companyId/:userId` — `authorize('company:read/update')`.
  - Ответы: raw.
- Members (`server/src/routes/crm/userCompanyRouter.js` → `server/src/controllers/crm/UserCompany.controller.js`)
  - GET `/members/:companyId/users` — список (ACL: `member:read*`, дополнительно проверяется в `userCompanyService`).
  - POST `/members/:companyId/users` — добавить (ACL: `member:create*`).
  - PUT `/members/:companyId/users/:userId` — update (ACL: `member:update*`).
  - DELETE `/members/:companyId/users/:userId` — remove (ACL: `member:delete*`).
  - Ответы: `{ items, total, page, limit }` или raw объекты.
- Departments (`server/src/routes/crm/departmentRouter.js` → `server/src/controllers/crm/Department.controller.js`)
  - GET/POST/PUT/DELETE `/departments/:companyId[/:id]`; только `requireMember`, без permissions.
- Counterparties (`server/src/routes/crm/counterpartyRouter.js` → `server/src/controllers/crm/Counterparty.controller.js`)
  - GET/POST/PUT/DELETE `/counterparties/:companyId[/:id]`, POST `/:id/convert-lead`.
  - `requireMember` без permissions; companyId берётся из params.
  - Ответы: list через `packResult` (items/total/limit/page), остальные raw.
- Contact points (`server/src/routes/crm/contactPointRouter.js` → `server/src/controllers/crm/СontactPoint.controller.js`)
  - GET/POST/PUT/DELETE `/contact-points/:companyId[/:id]`.
  - `requireMember` + `authorize('contact:*')` + Joi схемы (`server/src/schemas/contactPointSchema.js`).
- Contacts (`server/src/routes/crm/contactRouter.js` → `server/src/controllers/crm/Contact.controller.js`)
  - GET/POST/PUT/DELETE `/contact/:companyId[/:id]`, POST `/:id/restore`; `requireMember` без permissions.
- Deals (`server/src/routes/crm/dealRouter.js` → `server/src/controllers/crm/Deal.controller.js`)
  - GET `/deals`, GET `/deals/:id`, POST/PUT/DELETE `/deals/:id`.
  - `authorize('deal:*')`, list/create/update валидируются Joi (`server/src/schemas/dealSchema.js`).
  - Ответы: list `{ data, meta }`, остальные raw.
- Tasks (`server/src/routes/crm/taskRouter.js` → `server/src/controllers/crm/Task.controller.js`)
  - GET `/tasks/:companyId`, GET `/tasks/:companyId/calendar`, GET `/tasks/:companyId/:id`, POST/PUT/DELETE `/tasks/:companyId/:id`, POST `/:id/restore`.
  - `requireMember` без permissions; companyId берётся из params.
  - Ответы: list `{ items, meta }`, остальные `{ data }` или `204`.
- Notes (`server/src/routes/crm/noteRouter.js` → `server/src/controllers/crm/Note.controller.js`)
  - GET/POST `/notes`, PUT/DELETE `/notes/:id`; auth only; responses raw.
- Pipelines (`server/src/routes/crm/pipelineRouter.js`) — CRUD в контроллере есть, но роутер НЕ подключён в `server/src/routes/rootRouter.js`.

#### PIM
- Базовые CRUD-роутеры (`server/src/routes/pim/*.router.js`) для большинства сущностей: GET `/`, GET `/:id`, POST `/`, PUT `/:id`, DELETE `/:id`.
- Product commands (`server/src/routes/pim/product.router.js`): GET `/:id`, POST `/:id/publish`, POST `/:id/archive`, POST `/:id/duplicate`, POST `/:id/variant-matrix`, PUT `/:id/attributes`.
- Extras:
  - Price lists (`server/src/routes/pim/priceList.extras.router.js`): PUT `/:id/items`, GET `/:id/best-price`.
  - Channels (`server/src/routes/pim/channel.extras.router.js`): PUT `/:id/listings`.
- Permissions: нигде не проверяются (только auth на уровне rootRouter).
- Ответы: list обычно `{ data, meta }`, остальные — raw.
- Несоответствие: `/products` не имеет GET list и POST create (в `product.router.js` нет этих эндпоинтов).

#### WMS
- CRUD роутеры (`server/src/routes/wms/*.router.js`) для большинства сущностей: GET `/`, GET `/:id`, POST `/`, PUT `/:id`, DELETE `/:id`.
- Команды:
  - `/wms/inventory` — GET `/onhand`, POST `/reserve`, POST `/reservation/:id/release`.
  - `/wms/receipts` — POST `/`, POST `/item/:itemId/receive`.
  - `/wms/picks` — POST `/wave`, POST `/task/:id/complete`.
  - `/wms/shipments` — POST `/`, POST `/item/:itemId/ship`.
  - `/wms/transfers` — POST `/`, POST `/item/:itemId/execute`.
  - `/wms/adjustments` — POST `/`.
- Несоответствие: `adjustment.router.js`, `receipt.router.js`, `shipment.router.js`, `transfer.router.js` содержат только POST-эндпоинты (list/get/update/delete отсутствуют).
- Permissions: не используются (кроме auth в rootRouter).
- Ответы: list `{ data, meta }`, остальные raw.

#### OMS
- Роутеры (`server/src/routes/oms/*.js`) есть, но НЕ подключены в `server/src/routes/rootRouter.js` → эндпоинты фактически недоступны.
- Эндпоинты:
  - Offers: GET `/`, GET `/:id`, POST `/`, PUT `/:id`, DELETE `/:id`, POST `/convert/:id`.
  - Orders: GET `/`, GET `/:id`, POST `/`, PUT `/:id`, DELETE `/:id`, POST `/from-offer/:id`.
  - Payments: GET `/`, POST `/`.
- Ответы: raw, ошибки через `next`.

#### Общее по контроллерам/форматам
- Много контроллеров не соблюдают README-правило `try/catch + next(error)` и возвращают ошибки напрямую (например `server/src/controllers/pim/*.controller.js`, `server/src/controllers/wms/*.controller.js`).
- Формат ответа не унифицирован: встречаются `{ data, meta }`, `{ items, meta }`, raw объекты, `{ ok: true }`, `204` без тела.

## 3. Frontend — инвентаризация

### 3.1 Pages и назначение
- Auth: `client/src/pages/auth/AuthPage/index.js` (sign in/up), `client/src/pages/auth/ResetPasswordPage/index.js`, `client/src/pages/auth/CompanySetupPage/index.js`, `client/src/pages/auth/InviteAcceptPage/index.js`.
- Main layout: `client/src/pages/system/MainLayoutPage/index.js` — основной каркас (sidebar/topbar).
- Dashboard: `client/src/components/Dashboard/index.js` (route `/main/pulpit`).
- Users: `client/src/pages/users/UserProfilePage/index.js`, `client/src/pages/users/UserEntityPage/index.js`, `client/src/pages/users/UserDetailTabs/index.js`, `client/src/pages/users/UserSettingsPage/*`.
- Company: `client/src/pages/company/CompanyInfoPage/index.js`, `client/src/pages/company/CompanyUsers/index.js`, `client/src/pages/company/CompanySettings/index.js`, `client/src/pages/company/CompanySettings/Modules/CompanyModules/index.js`, `client/src/pages/company/CompanySettings/Modules/CompanyDeals/index.js`.
- CRM: `client/src/pages/CRM/Counterparty/CounterpartiesPage/index.js`, `client/src/pages/CRM/Counterparty/CounterpartyDetailPage/index.js`, `client/src/pages/CRM/Lead/LeadsPage/index.js`, `client/src/pages/CRM/Lead/LeadDetailPage/index.js`, `client/src/pages/CRM/Client/ClientsPage/index.js`, `client/src/pages/CRM/Client/ClientDetailPage/index.js`, `client/src/pages/CRM/CounterpartyForm/index.js`.
- Tasks: `client/src/pages/system/TaskPage/index.js`, `client/src/pages/system/TaskPage/TaskDetailPage/index.js`, `client/src/pages/system/TaskPage/TaskForm/index.js`, `client/src/pages/system/TaskPage/TaskDetailTabs/index.js`.
- Calendar: `client/src/pages/system/CalendarPage/index.js`.
- Notifications: `client/src/pages/system/NotificationsPage/index.js`.
- Chat: `client/src/pages/Chat/index.js`, `client/src/pages/Chat/ChatWindow/index.js`, `client/src/pages/Chat/ChatSidebar/index.js`, `client/src/pages/Chat/ChatInput/index.js`, `client/src/pages/Chat/ChatCreateDirect/index.js`.
- Scaffold: `client/src/pages/_scaffold/EntityDetailPage.js` — заготовка для detail страниц.

### 3.2 Store-модули / slices и данные
- `client/src/store/slices/authSlice.js` — токены, companyId, currentUser, avatarRev.
- `client/src/store/slices/chatSlice.js` — активная комната, rooms, messages, pinned, drafts.
- `client/src/store/slices/lookupsSlice.js` — кэш справочников (members, departments, contacts, counterparties, deals).
- `client/src/store/slices/bootstrapSlice.js` — prefetch (companyUsers, counterparties, roles), флаги loaded/checked.
- `client/src/store/slices/sessionSlice.js` — session (token/user/companyId), но не подключён к store.
- `client/src/store/rtk/crmApi.js` — базовый RTK Query (auth header, refresh flow).
- `client/src/store/rtk/authApi.js` — register/login/verify/resend/reset.
- `client/src/store/rtk/sessionApi.js` — login/refresh/logout + socket init.
- `client/src/store/rtk/companyApi.js` — get/update company.
- `client/src/store/rtk/companyUsersApi.js` — list/add/update/remove members + invitations.
- `client/src/store/rtk/counterpartyApi.js` — list/get/create/update/delete counterparties.
- `client/src/store/rtk/tasksApi.js` — list/get/create/update/delete tasks.
- `client/src/store/rtk/userApi.js` — me/preferences, lookup.
- `client/src/store/rtk/chatApi.js` — chat rooms/messages/pins.
- `client/src/store/rtk/notificationApi.js` — notifications list + mark read.
- `client/src/store/rtk/uploadApi.js` — uploads/attach by URL.
- `client/src/store/rtk/aclApi.js` — ACL (roles/permissions) (файл есть, но в страницах не используется).
- `client/src/store/rtk/realtime.js` — SSE обработка.

### 3.3 Pages → store usage (основное)
- `client/src/pages/company/CompanyInfoPage/index.js` → `companyApi`, `uploadApi`, `authSlice`.
- `client/src/pages/company/CompanyUsers/index.js` → `companyUsersApi`.
- `client/src/pages/CRM/*` (Counterparties/Leads/Clients) → `counterpartyApi`.
- `client/src/pages/system/TaskPage/index.js` → `tasksApi` (create/list), локальные lookups из localStorage.
- `client/src/pages/system/TaskPage/TaskDetailPage/index.js` → `tasksApi` (get/update).
- `client/src/pages/system/NotificationsPage/index.js` → `notificationApi`.
- `client/src/pages/users/UserProfilePage/index.js` → `userApi` (getMe/updateMe).
- `client/src/pages/users/UserEntityPage/index.js` → `companyUsersApi` (get/update member).
- `client/src/pages/users/UserDetailTabs/index.js` + `UserSettingsPage/sections/*` → `userApi`, `uploadApi`, `authSlice`.
- `client/src/pages/Chat/*` → `chatApi`, `chatSlice`, `bootstrapSlice`, `authSlice`.
- `client/src/pages/system/MainLayoutPage/index.js` → `sessionApi`, `authSlice`, `chatSlice`.

### 3.4 Дублирующиеся UI-блоки (>=2)
- Списки CRM: `client/src/pages/CRM/Counterparty/CounterpartiesPage/index.js`, `client/src/pages/CRM/Lead/LeadsPage/index.js`, `client/src/pages/CRM/Client/ClientsPage/index.js` — почти одинаковая структура ListPage + FilterToolbar + AddButton + Modal + CounterpartyForm + колонки (LinkCell/AddressCell).
- Модальные формы с одинаковым футером (Cancel/Save) повторяются в `CounterpartiesPage`, `LeadsPage`, `ClientsPage`, `TaskPage` (`client/src/pages/system/TaskPage/index.js`).
- Табличный ListPage + FilterToolbar паттерн повторяется в `CounterpartiesPage`, `LeadsPage`, `ClientsPage`, `TaskPage`, `CompanyUsers` (частично другой UI, но логика похожа).

## 4. Оценка зрелости

### ГОТОВО
- Базовый stack: Express + Sequelize + PostgreSQL + React + RTK Query (`server/app.js`, `client/src/store`).
- Базовая auth/refresh модель (`server/src/utils/tokenService.js`, `server/src/controllers/system/Auth.controller.js`, `client/src/store/rtk/sessionApi.js`).
- Чаты (Mongo) + realtime слой (`server/src/services/system/chat/chatService.js`, `client/src/pages/Chat`).

### СЫРОЕ
- Multi-tenant безопасность: часть сервисов фильтрует по companyId, но часто берётся из params/query/body и не проверяется на соответствие auth; get/update/delete в PIM/WMS/OMS часто без company scope.
- RBAC: инфраструктура есть (ACL модели, `authorize`, `permissionResolver`), но почти не используется; есть опечатки (`compamy:*`) и несогласованные permission names.
- Формат ответов: неоднороден (raw / `{data, meta}` / `{items, meta}` / `204`).
- Валидация: только часть эндпоинтов использует Joi.
- Pagination: есть в некоторых list-эндпоинтах, но не везде, и формат разный.
- UI feature gating/модули: в `CompanyModules` и `CompanyDeals` — только фронтовая заглушка, нет backend/хранилища.

### ОТСУТСТВУЕТ
- Subscriptions / plans / feature gating на backend (модели, проверки, лимиты).
- Единый API контракт в реализации (сейчас README есть, в коде нет).
- Полный audit/logging (есть SystemEvent модель, но нет систематического использования).
- AI Assistant слой (нет data-ai-id, нет сервисов/моделей для AI).

## 5. Риски
- Возможная утечка данных между тенантами из-за companyId из params/query/body без строгой проверки и отсутствия company scope на get/update/delete (PIM/WMS/OMS/часть CRM).
- Недостаточные проверки прав: большинство эндпоинтов без `authorize`; опечатка `compamy:*` блокирует update/delete компаний; permission `company:owner:assign` отсутствует в `server/src/constants/permissions.js`.
- Несогласованность frontend↔backend:
  - `companyUsersApi.updateUserRole` использует `/members/:companyId/users/:userId/role`, но backend ожидает `/members/:companyId/users/:userId` (`client/src/store/rtk/companyUsersApi.js`, `server/src/routes/crm/userCompanyRouter.js`).
  - `userApi.getUserById` и `updateUserById` вызывают `/users/:userId`, backend требует `/users/:companyId/:userId` (`client/src/store/rtk/userApi.js`, `server/src/routes/crm/userRouter.js`).
  - `userApi.addMyContact` использует `/users/me/contacts`, такого роутера нет.
  - OMS роутеры не подключены в `rootRouter` → API недоступно.
- Архитектурные долги: duplicate upload пути (`/attachments` vs `/uploads`), модели/сервисы с разными именами (`Attachments` vs `Attachment`).

## 6. Что дописать в Readme.md (реальные блоки)

### 6.1 Фактическая карта сущностей (Domain Map)
```md
## Domain Map (фактические сущности)

### CRM
- Company (`companies`): id, name, nip/regon/krs, ownerUserId
- User (`users`): email, passwordHash, isActive
- UserCompany (`user_companies`): userId, companyId, role, status, departmentId, isLead
- CompanyDepartment (`company_departments`): name, description
- Counterparty (`counterparties`): type/status, nip/regon/krs, mainResponsibleUserId
- Contact (`contacts`): counterpartyId, mainResponsibleUserId, displayName
- ContactPoint (`contact_points`): ownerType/ownerId, channel, valueRaw/valueNorm
- Deal (`deals`): counterpartyId, status, value, responsibleId, pipelineId, stageId
- Task (`tasks`): title, status, priority, startAt/endAt, counterpartyId, dealId
- Note (`notes`): ownerType/ownerId, content, visibility
- ACL: Role, Permission, RolePermission, UserRole, UserPermission
- Pipelines: CrmPipeline, CrmPipelineStage (router пока не подключен)

### PIM
- Product + ProductVariant
- Brand, Category, Tag, Collection
- Attribute + AttributeOption + ProductAttributeValue
- PriceList + PriceListItem
- Channel + ChannelListing + ChannelCategoryMap
- PackagingUnit, ProductAttachment, ProductSupplier, ProductExternalRef, ProductLocalization, ProductRelation, ProductComponent

### WMS
- Warehouse, Location, InventoryItem, StockMove
- Receipt + ReceiptItem
- Shipment + ShipmentItem + Parcel
- TransferOrder + TransferItem
- CycleCount + CountItem
- Adjustment + AdjustmentItem
- Reservation, Lot, Serial, PickWave + PickTask

### OMS
- Offer + OfferItem
- Order + OrderItem + OrderEvent + OrderNote
- Invoice + CreditNote
- Payment, Discount, Promotion, Coupon, Package

### System
- Notification
- UserPreferences
- SystemEvent, SystemWebhook(+Delivery), SystemWorkflow(+Trigger), SystemJob(+Run), Sequence
- Attachments
- RefreshToken, PasswordResetTokens
```

### 6.2 Реальные permissions (из кода)
```md
## Permissions (факт из constants/permissions.js)
- company:read, company:update
- user:create, user:read, user:read:own, user:update, user:update:own, user:delete
- member:create, member:read, member:read:own, member:update, member:update:own, member:delete
- counterparty:read, counterparty:create, counterparty:update, counterparty:delete
- deal:read, deal:create, deal:update, deal:update:own, deal:delete
- task:read, task:create, task:update, task:update:own, task:delete
- contact:read, contact:read:own, contact:create, contact:update, contact:update:own, contact:delete
- product:read, product:create, product:update, product:delete
- offer:read, offer:create, offer:update, offer:delete, offer:convert
- order:read, order:create, order:update, order:delete, order:from_offer
- note:read, note:create, note:update, note:delete
- attachment:read, attachment:upload, attachment:delete
```

### 6.3 Реальные ENV переменные
```md
## Environment (факт из кода)
Backend:
- DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD
- MONGO_URI
- JWT_SECRET, JWT_ACCESS_SECRET, JWT_REFRESH_SECRET
- JWT_ACCESS_TTL, JWT_REFRESH_TTL_HOURS, JWT_REFRESH_TTL_DAYS
- APP_URL, CORS_ORIGINS
- GMAIL_USER, GMAIL_APP_PASSWORD, MAIL_FROM_NAME, MAIL_FROM_ADDR
- PASSWORD_RESET_TTL_HOURS
- INVITE_TTL_DAYS
- SEED_COMPANY_ID

Frontend:
- REACT_APP_API_URL
```

### 6.4 Реальные entrypoints / запуск
```md
## Запуск (факт из package.json)
Backend:
- `npm install` (в `server/`)
- `npm run start` (nodemon, стартует `server/index.js`)

Frontend:
- `npm install` (в `client/`)
- `npm run start`
```

### 6.5 Реальные API-группы (по роутерам)
```md
## API routes (факт из routes)
System:
- /auth, /acl, /notifications, /attachments, /uploads, /invitations, /system (preferences), /webhooks, /workflow, /events, /chat, /sse
CRM:
- /companies, /users, /members, /departments, /counterparties, /contact-points, /contact, /deals, /tasks, /notes
PIM:
- /brands, /categories, /uoms, /product-types, /attributes, /attribute-options, /product-attribute-values,
  /product-variants, /variant-options, /product-categories, /product-attachments, /tags, /product-tags,
  /collections, /product-collections, /product-relations, /product-components, /channels, /channel-listings,
  /channel-category-maps, /price-lists, /price-list-items, /product-localizations, /packaging-units,
  /product-suppliers, /product-external-refs, /tax-categories, /shipping-classes
WMS:
- /warehouses, /locations, /lots, /serials, /inventory-items, /reservations, /stock-moves,
  /receipts, /receipt-items, /transfers, /transfer-items, /pick-waves, /pick-tasks,
  /shipments, /shipment-items, /parcels, /adjustments, /adjustment-items, /cycle-counts, /count-items
- Commands: /wms/inventory, /wms/receipts, /wms/picks, /wms/shipments, /wms/transfers, /wms/adjustments
OMS:
- /offers, /orders, /payments (роутеры есть, но не подключены в rootRouter)
```

### 6.6 Realtime слой
```md
## Realtime (факт)
- SSE: `GET /sse?token=...&companyId=...` (`server/src/routes/system/sseRouter.js`)
- Socket.io: `server/src/socket/*`, чат на Mongo (`server/src/mongoModels/chat/*`)
```

